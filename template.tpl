___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Blutic Cookie Manager",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Enter your domain ID, choose whether to auto-block tracking, and voilà! You can now effortlessly monitor user preferences and banner designs created on https://cookie-management.blutic.club",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "domainId",
    "displayName": "Enter your Domain ID",
    "simpleValueType": true,
    "help": "Enter your unique domain identifier as found in Blutic Cookie Manager. This links your GTM tag to your banner configuration.",
    "valueHint": "Paste the Domain ID provided after creating your consent banner",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "autoBlock",
    "checkboxText": "Auto Block Tracking",
    "simpleValueType": true,
    "defaultValue": false,
    "help": "When checked, blocks all tracking and analytics scripts by default. Scripts will only run after users have explicitly given consent via your banner."
  },
  {
    "type": "GROUP",
    "name": "defaultSettings",
    "displayName": "Region-Specific Consent Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "settingsTable",
        "displayName": "",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "displayName": "Region",
              "simpleValueType": true,
              "defaultValue": "all",
              "valueHint": "Comma-separated region codes (e.g., \u0027US,CA\u0027 or \u0027all\u0027)",
              "help": "Comma-separated ISO country/region codes (e.g. \u0027US,CA\u0027) or \u0027all\u0027 for global fallback."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "ad_storage",
              "displayName": "Ad Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted",
              "help": "Should advertising cookies/scripts (for ads/tracking) be loaded by default in this region?"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "analytics_storage",
              "displayName": "Analytics Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted",
              "help": "Should analytics cookies/scripts (e.g., Google Analytics) be enabled by default?"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "ad_personalization",
              "displayName": "Ad Personalization",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted",
              "help": "Enable personalized ads for users in these regions if consented."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "ad_user_data",
              "displayName": "Ad User Data",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted",
              "help": "Should user data be shared with Google for ad personalization/features?"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "functionality_storage",
              "displayName": "Functional Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "help": "Storage supporting site/app functionality (e.g., UI prefs)",
              "defaultValue": "granted"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "wait_for_update",
              "displayName": "Wait for Update (ms)",
              "simpleValueType": true,
              "help": "Delay for Google tags to wait for a consent update (in milliseconds) after page load.",
              "valueValidators": [
                {
                  "type": "NUMBER"
                }
              ],
              "defaultValue": 500
            },
            "isUnique": false
          }
        ],
        "newRowButtonText": "Create",
        "newRowTitle": "Create",
        "editRowTitle": "Edit",
        "valueValidators": [
          {
            "type": "STRING_LENGTH",
            "args": [
              1
            ]
          }
        ]
      }
    ],
    "help": "Set default consent values for different countries or regions. Add one row for each group of users that should get different defaults. For global fallback, use \u0027all\u0027."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const injectScript = require('injectScript');
const createQueue = require('createQueue');
const dataLayerPush = createQueue('dataLayer');
const setDefaultConsentState = require('setDefaultConsentState');
const encodeUriComponent = require('encodeUriComponent');

log('data =', data);

const domainId = data.domainId;

// Validate required input
if (!domainId || domainId.trim() === '') {
  log('Error: Domain ID is required');
  data.gtmOnFailure();
  return;
}

// Global default consent settings (all granted by default)
// These will be applied to all regions unless specifically overridden
const globalDefaults = {
  ad_storage: 'granted',
  analytics_storage: 'granted',
  ad_user_data: 'granted',
  ad_personalization: 'granted',
  functionality_storage: 'granted',
  security_storage: 'granted',
  wait_for_update: 500
};

log('Global default consent settings:', globalDefaults);

// Set global defaults first
setDefaultConsentState(globalDefaults);

// Push global defaults to dataLayer
dataLayerPush({
  event: 'consent_default_global',
  consent_state: globalDefaults,
  regions: 'all'
});

// Process region-specific consent settings if provided
const settingsTable = data.settingsTable || [];

if (settingsTable.length === 0) {
  log('No region-specific settings provided, using global defaults only');
} else {
  log('Processing region-specific consent settings:', settingsTable);
  
  settingsTable.forEach(function(setting, index) {
    log('Processing setting #' + (index + 1) + ':', setting);
    
    // Validate required fields
    if (!setting.regions) {
      log('Warning: Setting #' + (index + 1) + ' missing regions field, skipping');
      return;
    }
    
    // Build consent object, falling back to global defaults
    const settingObject = {
      ad_storage: setting.ad_storage || globalDefaults.ad_storage,
      analytics_storage: setting.analytics_storage || globalDefaults.analytics_storage,
      ad_user_data: setting.ad_user_data || globalDefaults.ad_user_data,
      ad_personalization: setting.ad_personalization || globalDefaults.ad_personalization,
      functionality_storage: setting.functionality_storage || globalDefaults.functionality_storage,
      security_storage: setting.security_storage || globalDefaults.security_storage,
      wait_for_update: setting.wait_for_update || globalDefaults.wait_for_update
    };
    
    // Process regions
    if (setting.regions !== 'all') {
      // Split regions and clean them up
      const regions = setting.regions.split(',').map(function(region) {
        return region.trim().toUpperCase(); // Normalize to uppercase
      }).filter(function(region) {
        return region.length > 0; // Remove empty strings
      });
      
      if (regions.length === 0) {
        log('Warning: No valid regions found in setting #' + (index + 1) + ', skipping');
        return;
      }
      
      settingObject.region = regions;
      log('Setting consent for specific regions:', regions, settingObject);
    } else {
      log('Setting consent for all regions:', settingObject);
    }
    
    // Set region-specific consent state
    setDefaultConsentState(settingObject);
    
    // Push to dataLayer for tracking/debugging
    dataLayerPush({
      event: 'consent_default_region',
      consent_state: settingObject,
      regions: setting.regions,
      setting_index: index + 1
    });
  });
}

// Build the script URL with encoded domainId
const scriptUrl = 'https://cdn.jsdelivr.net/gh/Blutic-club/banner-sdk@v1.0.0/dist/banner-sdk.js?domainId=' + encodeUriComponent(domainId);
log('Script URL:', scriptUrl);

// Inject the banner SDK script
injectScript(scriptUrl, function() {
  log('Banner SDK loaded successfully');
  
  // Push success event to dataLayer
  dataLayerPush({
    event: 'banner_sdk_loaded',
    domain_id: domainId,
    script_url: scriptUrl
  });
  
  data.gtmOnSuccess();
}, function() {
  log('Failed to load Banner SDK');
  
  // Push failure event to dataLayer
  dataLayerPush({
    event: 'banner_sdk_load_failed',
    domain_id: domainId,
    script_url: scriptUrl,
    error: 'Script injection failed'
  });
  
  data.gtmOnFailure();
});


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn.jsdelivr.net/gh/omgitsvaibhav/banner-sdk@*/dist/banner-sdk.js*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "access_globals"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 05/08/2025, 11:37:09


